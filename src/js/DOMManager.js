import*as a from"three";import*as n from"./Event.js";import{Disk as u}from"./Object.js";import{sleep as s}from"./Utils.js";import i from"./GameManager.js";import r from"./section/GameSection/GameSection.js";import e from"./Player.js";export default class t{#gameManager;#rendererManager;#cameraManager;#titleScreenDOM;#startButton;#ingameUIContainer;#cutDOM;#ingameButtons;#passButton;#bangButton;#resultScreenDOM;#restartButton;#playerAngerDOM;#shareLink;#DOMEventController;constructor(e,t,a){this.#gameManager=e;this.#rendererManager=t;this.#cameraManager=a;this.#titleScreenDOM=document.getElementById("title_screen");this.#startButton=document.getElementById("start_button");this.#ingameUIContainer=document.getElementById("ingame_ui");this.#cutDOM=document.getElementById("cut");this.#ingameButtons=document.getElementById("action_button");[this.#passButton,this.#bangButton]=this.#ingameButtons.children;this.#resultScreenDOM=document.getElementById("result_screen");this.#restartButton=document.getElementById("restart_button");this.#playerAngerDOM=document.getElementById("meter_value");this.#playerAngerDOM.style.height=`0%`;this.#shareLink=document.getElementById("share_button");this.hide(this.#bangButton);this.#DOMEventController=new AbortController;this.#gameManager.addEventListener("turn_notice",e=>{if(e.order!=this.#gameManager.player.order)return;if(e.canPut){this.#passButton.classList.add("disabled");this.#bangButton.classList.remove("disabled");if(this.#gameManager.player.anger>=this.#gameManager.player.patience){this.show(this.#bangButton);this.show(document.getElementById("steam_left"));this.show(document.getElementById("steam_right"))}}else{this.#passButton.classList.remove("disabled");this.#bangButton.classList.add("disabled")}});this.#gameManager.addEventListener("put_success",e=>{if(e.order==this.#gameManager.player.order){this.#passButton.classList.add("disabled");this.#bangButton.classList.add("disabled")}});this.#gameManager.addEventListener("bang_success",e=>{if(e.order==this.#gameManager.player.order){this.#passButton.classList.add("disabled");this.#bangButton.classList.add("disabled");this.#gameManager.currentSection.mode=r.MODE_PUT;this.show(this.#ingameButtons);this.hide(document.getElementById("steam_left"));this.hide(document.getElementById("steam_right"))}});this.#gameManager.addEventListener("game_over",async e=>{this.#bangButton.classList.remove("active");this.#bangButton.classList.add("disabled");this.hide(this.#ingameUIContainer);await s(50);await this.cutin("ゲーム終了",this.#gameManager.audio.start,2e3);await s(750);this.createShareLink(e.result.result);this.drawResultScreen(e.result)});this.#gameManager.addEventListener("game_restart",()=>{this.#gameManager.logger.log("GAME RESTART");this.hide(this.#resultScreenDOM);this.hide(this.#ingameUIContainer);this.show(this.#titleScreenDOM);this.#DOMEventController.abort()})}addDOMEventListeners(){const e=document.getElementById("caution_screen");const t=()=>{let e=window.innerWidth;let t=window.innerHeight;if(e<t)[e,t]=[t,e];document.getElementById("main-canvas").style.width=e;document.getElementById("main-canvas").style.height=t;this.#rendererManager.renderer.setSize(window.innerWidth,window.innerHeight);this.#rendererManager.renderer.setPixelRatio(window.devicePixelRatio);this.#rendererManager.camera.aspect=window.innerWidth/window.innerHeight;this.#rendererManager.camera.updateProjectionMatrix()};screen.orientation.addEventListener("change",()=>{if(!screen.orientation.type.includes("landscape")){this.show(e,true)}else{t();this.hide(e)}},{signal:this.#DOMEventController.signal});this.#startButton.addEventListener("click",async()=>{this.#gameManager.logger.log("* send: game_start");this.orderUpdate();this.hide(this.#titleScreenDOM);this.#gameManager.audio.open.play();await this.cutin("ゲームスタート",this.#gameManager.audio.start,2e3);this.show(this.#ingameUIContainer);this.#gameManager.dispatchEvent(new n.GameStartEvent);this.#gameManager.mode=document.getElementById("game_mode").checked?i.MODE_HOTHEADED:i.MODE_NORMAL;if(this.#gameManager.mode===i.MODE_HOTHEADED)this.#gameManager.player.patience=10;document.getElementById("boiling_point").style.bottom=`${this.#gameManager.player.patience}%`},{signal:this.#DOMEventController.signal});this.#passButton.addEventListener("click",()=>{if(this.#gameManager.currentTurn!=this.#gameManager.player.order||this.#gameManager.checkTable(this.#gameManager.player.order))return;this.#gameManager.dispatchEvent(new n.PutPassEvent(this.#gameManager.player.order));this.#passButton.classList.add("disabled")},{signal:this.#DOMEventController.signal});this.#bangButton.addEventListener("click",async()=>{if(this.#gameManager.currentTurn!=this.#gameManager.player.order)return;this.hide(this.#ingameButtons);this.hide(this.#bangButton);this.#gameManager.currentSection.mode=r.MODE_BANG;this.#cameraManager.moveTo(0,100,0,new a.Vector3(0,0,0),false,()=>{},20);await this.cutin("たたけ!",this.#gameManager.audio.bang_cut,1e3)},{signal:this.#DOMEventController.signal});this.#restartButton.addEventListener("click",e=>{this.#gameManager.dispatchEvent(new n.GameRestartEvent)},{signal:this.#DOMEventController.signal})}drawResultScreen(e){let t=document.getElementById("winner");let a=document.getElementById("score");let n=document.getElementById("order_black_name");let s=document.getElementById("order_white_name");let i=document.getElementById("order_black");let r=document.getElementById("order_white");let o=document.getElementById("time");let d=Math.max(3,this.#gameManager.player.name?.length||6);let l=this.#gameManager.endTime.getTime()-this.#gameManager.startTime.getTime();let h=l/(1e3*60*60);let g=(h-Math.floor(h))*60;let m=(g-Math.floor(g))*60;let c="";this.show(this.#resultScreenDOM);if(e.result==u.EMPTY){c="引き分け!"}else{c=`${e.result==u.WHITE?this.#gameManager.player.name||"Player":"COM"}の勝ち!`}t.innerText=c;a.innerText=this.#gameManager.player.point;s.innerText=`${this.getPlayerName()||"Player"}`;s.style.width=`${d+1}rem`;r.innerText=` : ${e.white}`;n.innerText=`${this.#gameManager.enemy.name}`;n.style.width=`${d+1}rem`;i.innerText=` : ${e.black}`;o.innerText=`${("00"+Math.floor(h)).slice(-2)}:${("00"+Math.floor(g)).slice(-2)}:${("00"+Math.round(m)).slice(-2)}`}createShareLink(e){const t=[" 勝利😎"," 敗北☹️"," 引き分け😶"];const a=this.#gameManager.player.point;const n=`台パンリバーシで${a}点を取ったよ！ [${t[e]}]\n`;const s=`http://twitter.com/share?url=reversi.syntck.com&text=${n}&hashtags=台パンリバーシ`;this.#shareLink.setAttribute("href",s)}async cutin(e,t,a){this.#cutDOM.children[0].innerText=e;this.show(this.#cutDOM);this.#cutDOM.classList.add("fadeIn");await s(a/10*1);t.pause();t.currentTime=0;t.play();await s(a/10*9);this.hide(this.#cutDOM);this.#cutDOM.classList.remove("fadeIn")}show(e,t=false){if(t){e.style.display="flex"}else{e.style.display="block"}}getPlayerName(){return document.getElementById("player_name").value||null}orderUpdate(){let e=document.getElementById("order");if(this.#gameManager.currentTurn==u.BLACK){e.children[0].innerText="黒";e.classList.remove("order-white");e.classList.add("order-black")}else{e.children[0].innerText="白";e.classList.remove("order-black");e.classList.add("order-white")}}angerUpdate(){let e=this.#gameManager.player.anger;this.#playerAngerDOM.style.height=`${Math.min(e,98)}%`}hide(e){e.style.display="none"}modeReset(){this.#bangButton.classList.remove("active");this.#gameManager.currentSection.mode=r.MODE_NONE}}
